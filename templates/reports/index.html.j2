{% extends "base.html.j2" %}

{% block title %}Rapport Linxo - {{ report_date }}{% endblock %}

{% block header_title %}Rapport Budget du {{ report_date }}{% endblock %}
{% block header_subtitle %}Vue d'ensemble par famille de d√©penses{% endblock %}

{% block content %}
<div class="summary-card">
    <div class="summary-item">
        <span class="summary-label">Total des d√©penses</span>
        <span class="summary-value">{{ "%.2f"|format(grand_total) }} ‚Ç¨</span>
    </div>
    <div class="summary-item">
        <span class="summary-label">Nombre de transactions</span>
        <span class="summary-value">{{ total_transactions }}</span>
    </div>
</div>

{% if total_fixes is defined and total_variables is defined %}
<div class="summary-card">
    <div class="summary-item">
        <span class="summary-label">üí≥ Frais r√©currents (fixes)</span>
        <span class="summary-value">{{ "%.2f"|format(total_fixes) }} ‚Ç¨</span>
    </div>
    <div class="summary-item">
        <span class="summary-label">üõí D√©penses variables</span>
        <span class="summary-value">{{ "%.2f"|format(total_variables) }} ‚Ç¨</span>
    </div>
</div>
{% endif %}

{% if budget_max is defined and budget_max > 0 %}
<div class="progress-section">
    <h3>Avancement du budget</h3>
    <div class="progress-info">
        <span>Jour {{ jour_actuel }}/{{ dernier_jour }} du mois ({{ "%.0f"|format(avancement_mois) }}%)</span>
        <span>D√©pens√©: {{ "%.0f"|format(pourcentage) }}%</span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar-fill" style="width: {{ "%.1f"|format(pourcentage) }}%; background: {{ couleur_barre_variables }};">
            {{ "%.0f"|format(pourcentage) }}%
        </div>
        <div class="progress-marker-100"></div>
        <div class="progress-marker-time" style="left: {{ "%.1f"|format(avancement_mois) }}%;">
            <span class="marker-label">Aujourd'hui</span>
        </div>
    </div>
    <p class="progress-hint">
        {% if pourcentage > avancement_mois + 10 %}
        ‚ö†Ô∏è Vous √™tes en avance sur votre budget (d√©pens√© {{ "%.0f"|format(pourcentage - avancement_mois) }}% de plus que pr√©vu √† cette date)
        {% elif pourcentage < avancement_mois - 10 %}
        ‚úÖ Vous √™tes en retard sur votre budget (√©conomis√© {{ "%.0f"|format(avancement_mois - pourcentage) }}% de plus que pr√©vu)
        {% else %}
        üëç Votre rythme de d√©penses est conforme au budget
        {% endif %}
    </p>
</div>

{% if prediction_fin_mois is defined %}
<div class="prediction-box" style="border-left-color: {{ couleur_prediction }};">
    <h3>üîÆ Pr√©diction fin de mois</h3>
    <div class="prediction-value" style="color: {{ couleur_prediction }};">
        {{ "%.2f"|format(prediction_fin_mois) }} ‚Ç¨
    </div>
    <div class="prediction-message" style="color: {{ couleur_prediction }};">
        {{ message_prediction }}
    </div>
    <div class="prediction-detail">
        üìä Bas√© sur {{ jours_restants }} jour{{ "s" if jours_restants > 1 else "" }} restant{{ "s" if jours_restants > 1 else "" }} dans le mois
    </div>
</div>
{% endif %}
{% endif %}

{% if conseil_llm %}
<div class="conseil-box">
    <h3>üí° Conseil de votre Agent Budget</h3>
    {% for ligne in conseil_llm.split('\n') %}
        {% if ligne.strip() %}
        <p>{{ ligne }}</p>
        {% endif %}
    {% endfor %}
</div>
{% endif %}

<div class="section">
    <h2>D√©penses par famille</h2>
    <p class="section-description">Cliquez sur une famille pour voir le d√©tail des transactions</p>

    <table class="families-table">
        <thead>
            <tr>
                <th>Famille</th>
                <th class="text-center">Transactions</th>
                <th class="text-right">Montant</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for family in families %}
            <tr>
                <td class="family-name">{{ family.name }}</td>
                <td class="text-center">{{ family.count }}</td>
                <td class="text-right amount-cell">{{ "%.2f"|format(family.total) }} ‚Ç¨</td>
                <td class="text-center">
                    <a href="{{ family.url }}" class="btn-detail">Voir le d√©tail ‚Üí</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td><strong>TOTAL</strong></td>
                <td class="text-center"><strong>{{ total_transactions }}</strong></td>
                <td class="text-right"><strong>{{ "%.2f"|format(grand_total) }} ‚Ç¨</strong></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>
{% endblock %}
