{% extends "base.html.j2" %}

{% block title %}{{ famille_name }} - Rapport Linxo{% endblock %}

{% block header_title %}{{ famille_name }}{% endblock %}
{% block header_subtitle %}Rapport du {{ report_date }}{% endblock %}

{% block content %}
<nav class="breadcrumb">
    <a href="{{ index_url }}">‚Üê Retour √† l'index</a>
</nav>

<div class="summary-card">
    <div class="summary-item">
        <span class="summary-label">Total {{ famille_name }}</span>
        <span class="summary-value">{{ "%.2f"|format(total) }} ‚Ç¨</span>
    </div>
    <div class="summary-item">
        <span class="summary-label">Nombre de transactions</span>
        <span class="summary-value">{{ count }}</span>
    </div>
</div>

{% if budget_max is defined and budget_max > 0 %}
<div class="progress-section">
    <h3>Avancement du budget</h3>
    <div class="progress-info">
        <span>Jour {{ jour_actuel }}/{{ dernier_jour }} du mois ({{ "%.0f"|format(avancement_mois) }}%)</span>
        <span>D√©pens√©: {{ "%.0f"|format(pourcentage_utilise) }}%</span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar-fill" style="width: {{ "%.1f"|format(pourcentage_utilise) }}%; background: {{ couleur_barre }};">
            {{ "%.0f"|format(pourcentage_utilise) }}%
        </div>
        <div class="progress-marker-100"></div>
        <div class="progress-marker-time" style="left: {{ "%.1f"|format(avancement_mois) }}%;">
            <span class="marker-label">Aujourd'hui</span>
        </div>
    </div>
    <p class="progress-hint">
        {% if pourcentage_utilise > avancement_mois + 10 %}
        ‚ö†Ô∏è Vous √™tes en avance sur votre budget (d√©pens√© {{ "%.0f"|format(pourcentage_utilise - avancement_mois) }}% de plus que pr√©vu √† cette date)
        {% elif pourcentage_utilise < avancement_mois - 10 %}
        ‚úÖ Vous √™tes en retard sur votre budget (√©conomis√© {{ "%.0f"|format(avancement_mois - pourcentage_utilise) }}% de plus que pr√©vu)
        {% else %}
        üëç Votre rythme de d√©penses est conforme au budget
        {% endif %}
    </p>
</div>

{% if prediction_fin_mois is defined %}
<div class="prediction-box" style="border-left-color: {{ couleur_prediction }};">
    <h3>üîÆ Pr√©diction fin de mois</h3>
    <div class="prediction-value" style="color: {{ couleur_prediction }};">
        {{ "%.2f"|format(prediction_fin_mois) }} ‚Ç¨
    </div>
    <div class="prediction-message" style="color: {{ couleur_prediction }};">
        {{ message_prediction }}
    </div>
    <div class="prediction-detail">
        üìä Bas√© sur {{ jours_restants }} jour{{ "s" if jours_restants > 1 else "" }} restant{{ "s" if jours_restants > 1 else "" }} dans le mois
    </div>
</div>
{% endif %}
{% endif %}

{% if conseil_llm %}
<div class="conseil-box">
    <h3>üí° Conseil de votre Agent Budget</h3>
    {% for ligne in conseil_llm.split('\n') %}
        {% if ligne.strip() %}
        <p>{{ ligne }}</p>
        {% endif %}
    {% endfor %}
</div>
{% endif %}

<div class="section">
    <h2>D√©tail des transactions</h2>
    <p class="section-description">Transactions tri√©es par date (plus r√©centes en premier)</p>

    <table class="transactions-table" id="transactions-table">
        <thead>
            <tr>
                <th class="sortable" data-sort="date">Date <span class="sort-icon">‚ñº</span></th>
                <th class="sortable" data-sort="categorie">Cat√©gorie <span class="sort-icon"></span></th>
                <th class="sortable" data-sort="libelle">Libell√© <span class="sort-icon"></span></th>
                <th class="sortable text-right" data-sort="montant">Montant <span class="sort-icon"></span></th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr>
                <td class="date-cell" data-date="{{ transaction.date }}">{{ transaction.date }}</td>
                <td class="categorie-cell">{{ transaction.categorie }}</td>
                <td class="libelle-cell">{{ transaction.libelle }}</td>
                <td class="amount-cell text-right" data-amount="{{ transaction.montant }}">{{ "%.2f"|format(transaction.montant) }} ‚Ç¨</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="3"><strong>TOTAL {{ famille_name }}</strong></td>
                <td class="text-right"><strong>{{ "%.2f"|format(total) }} ‚Ç¨</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
// Script de tri de table c√¥t√© client (l√©ger et simple)
(function() {
    const table = document.getElementById('transactions-table');
    if (!table) return;

    const headers = table.querySelectorAll('th.sortable');
    let currentSort = { column: 'date', order: 'desc' };

    function parseDate(dateStr) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        return new Date(0);
    }

    function sortTable(column, order) {
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        rows.sort((a, b) => {
            let aVal, bVal;

            if (column === 'date') {
                aVal = parseDate(a.querySelector('.date-cell').dataset.date || a.querySelector('.date-cell').textContent);
                bVal = parseDate(b.querySelector('.date-cell').dataset.date || b.querySelector('.date-cell').textContent);
            } else if (column === 'montant') {
                aVal = parseFloat(a.querySelector('.amount-cell').dataset.amount || 0);
                bVal = parseFloat(b.querySelector('.amount-cell').dataset.amount || 0);
            } else if (column === 'categorie') {
                aVal = a.querySelector('.categorie-cell').textContent.toLowerCase();
                bVal = b.querySelector('.categorie-cell').textContent.toLowerCase();
            } else if (column === 'libelle') {
                aVal = a.querySelector('.libelle-cell').textContent.toLowerCase();
                bVal = b.querySelector('.libelle-cell').textContent.toLowerCase();
            }

            if (aVal < bVal) return order === 'asc' ? -1 : 1;
            if (aVal > bVal) return order === 'asc' ? 1 : -1;
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));

        // Mettre √† jour les ic√¥nes de tri
        headers.forEach(header => {
            const icon = header.querySelector('.sort-icon');
            if (header.dataset.sort === column) {
                icon.textContent = order === 'asc' ? '‚ñ≤' : '‚ñº';
            } else {
                icon.textContent = '';
            }
        });
    }

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const column = header.dataset.sort;
            let order = 'asc';

            if (currentSort.column === column) {
                order = currentSort.order === 'asc' ? 'desc' : 'asc';
            }

            currentSort = { column, order };
            sortTable(column, order);
        });
    });

    // Tri initial par date d√©croissante
    sortTable('date', 'desc');
})();
</script>
{% endblock %}
