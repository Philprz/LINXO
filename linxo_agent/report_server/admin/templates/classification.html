{% extends "base.html" %}

{% block extra_css %}
<style>
    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        font-size: 0.9rem;
    }

    .table th {
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.75rem;
        color: #6c757d;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .actions-cell {
        display: flex;
        gap: 0.5rem;
    }

    .badge {
        display: inline-flex;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.75rem;
        align-items: center;
        gap: 0.3rem;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.85rem;
    }

    .history-item:last-child {
        border-bottom: none;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .modal-close {
        cursor: pointer;
        font-size: 1.5rem;
        color: #6c757d;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

    .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.3rem;
        color: #4a5568;
        font-weight: 600;
    }

    .form-input,
    .form-textarea,
    .form-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .form-select {
        background: #fff;
    }

    .form-textarea {
        resize: vertical;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
    }

    .helper-note {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card config-section">
    <div class="card-header">
        <div>
            <h2 class="card-title">ü§ñ Transactions √† valider</h2>
            <p style="font-size: 0.85rem; color: #6c757d;">
                Confirmez les classifications propos√©es ou corrigez-les pour entra√Æner le mod√®le.
            </p>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="limit-select" class="form-input" style="width: auto;">
                <option value="50">50 derni√®res</option>
                <option value="100" selected>100 derni√®res</option>
                <option value="200">200 derni√®res</option>
            </select>
            <button class="btn btn-secondary" onclick="loadTransactions()">üîÑ Actualiser</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Libell√©</th>
                    <th>Cat√©gorie</th>
                    <th>Montant</th>
                    <th>Confidence</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="transactions-body">
                <tr><td colspan="6" style="text-align:center;">Chargement...</td></tr>
            </tbody>
        </table>
    </div>

    <div style="margin-top: 0.75rem; font-size: 0.85rem; color: #6c757d;">
        Derni√®re mise √† jour : <span id="transactions-updated">--</span>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div>
            <h2 class="card-title">üìù Historique des corrections</h2>
            <p style="font-size: 0.85rem; color: #6c757d;">Suivi des validations et corrections envoy√©es au mod√®le.</p>
        </div>
    </div>
    <div id="history-list"></div>
</div>

<div id="correction-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Corriger la cat√©gorie</h3>
            <span class="modal-close" onclick="closeCorrectionModal()">√ó</span>
        </div>
        <div class="form-group">
            <label class="form-label">Libell√©</label>
            <input type="text" class="form-input" id="correction-libelle" readonly>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Cat√©gorie actuelle</label>
                <input type="text" class="form-input" id="correction-categorie-actuelle" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Nouvelle cat√©gorie</label>
                <select class="form-select" id="correction-categorie-nouvelle"></select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Type de d√©pense</label>
                <select class="form-select" id="correction-type">
                    <option value="variable">Variable</option>
                    <option value="recurrente">R√©currente</option>
                </select>
            </div>
            <div class="form-group" id="recurrence-mapping-group" style="display:none;">
                <label class="form-label">Associer √† une d√©pense r√©currente</label>
                <select class="form-select" id="recurrence-target">
                    <option value="">Cr√©er une nouvelle d√©pense r√©currente</option>
                </select>
                <div class="helper-note" id="recurrence-helper-note"></div>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Commentaire</label>
            <textarea class="form-textarea" id="correction-commentaire" rows="2"
                      placeholder="Expliquez pourquoi la cat√©gorie change"></textarea>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button class="btn btn-primary" style="flex:1;" onclick="submitCorrection()">üíæ Envoyer</button>
            <button class="btn btn-secondary" onclick="closeCorrectionModal()">Annuler</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let transactionsCache = [];
    let currentTransactionId = null;
    let categoriesCache = [];
    let recurrenceSuggestions = [];

    const currencyFormatter = new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'EUR',
        maximumFractionDigits: 2
    });

    function formatCurrency(value) {
        return currencyFormatter.format(value || 0);
    }

    function formatDateFr(dateStr) {
        if (!dateStr) return '--/--';
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            return `${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}`;
        }
        const d = new Date(dateStr);
        return Number.isNaN(d.getTime()) ? dateStr : d.toLocaleDateString('fr-FR');
    }

    async function loadTransactions() {
        const limit = document.getElementById('limit-select').value;
        try {
            const response = await fetch(`/admin/api/classification/transactions?limit=${limit}`);
            const data = await response.json();
            if (!data.success) {
                showNotification(data.error || 'Impossible de charger les transactions', 'error');
                return;
            }

            transactionsCache = data.transactions || [];
            renderTransactions(transactionsCache);
            document.getElementById('transactions-updated').textContent = new Date(data.generated_at || Date.now()).toLocaleString('fr-FR');
        } catch (error) {
            showNotification('Erreur lors du chargement des transactions', 'error');
        }
    }

    function renderTransactions(transactions) {
        const body = document.getElementById('transactions-body');
        if (!transactions.length) {
            body.innerHTML = '<tr><td colspan="6" style="text-align:center;">Aucune transaction √† valider</td></tr>';
            return;
        }

        body.innerHTML = transactions.map(tx => `
            <tr>
                <td>${tx.date || '--/--'}<br><small>${tx.compte || ''}</small></td>
                <td>
                    <strong>${tx.libelle}</strong><br>
                    <small>${tx.notes || ''}</small>
                </td>
                <td>
                    ${tx.categorie || 'Non class√©'}
                    ${tx.depense_recurrente ? '<span class="badge badge-success">Fixe</span>' : ''}
                </td>
                <td>${formatCurrency(tx.montant)}</td>
                <td>
                    ${tx.ml_confidence ? (tx.ml_confidence * 100).toFixed(0) + '%' : '‚Äî'}
                </td>
                <td class="actions-cell">
                    <button class="btn btn-success btn-small" onclick="markTransactionCorrect('${tx.id}')">‚úÖ Correct</button>
                    <button class="btn btn-primary btn-small" onclick="openCorrectionModal('${tx.id}')">‚úèÔ∏è Corriger</button>
                </td>
            </tr>
        `).join('');
    }

    async function markTransactionCorrect(id) {
        const tx = transactionsCache.find(t => t.id === id);
        if (!tx) return;

        try {
            const response = await fetch('/admin/api/classification/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transaction_id: tx.id,
                    libelle: tx.libelle,
                    categorie_initiale: tx.categorie,
                    statut: 'correct',
                    montant: tx.montant,
                    compte: tx.compte,
                    date_transaction: tx.date,
                    ml_confidence: tx.ml_confidence
                })
            });
            const result = await response.json();
            if (result.success) {
                showNotification('Merci pour la validation üëç', 'success');
                await loadTransactions();
                await loadHistory();
            } else {
                showNotification(result.error || 'Impossible d\'enregistrer la validation', 'error');
            }
        } catch (error) {
            showNotification('Erreur: ' + error.message, 'error');
        }
    }

    function populateCategorySelect(selectedValue) {
        const select = document.getElementById('correction-categorie-nouvelle');
        if (!select) return;
        const options = categoriesCache.length ? categoriesCache : [];
        const uniqueOptions = new Set(options);
        if (selectedValue) {
            uniqueOptions.add(selectedValue);
        }
        select.innerHTML = Array.from(uniqueOptions)
            .sort()
            .map(cat => `<option value="${cat}">${cat}</option>`)
            .join('');
        if (selectedValue) {
            select.value = selectedValue;
        }
    }

    async function loadCategories() {
        try {
            const response = await fetch('/admin/api/classification/categories');
            const data = await response.json();
            if (data.success) {
                categoriesCache = data.categories || [];
            }
        } catch (error) {
            console.error('Erreur chargement categories:', error);
        }
    }

    function openCorrectionModal(id) {
        const tx = transactionsCache.find(t => t.id === id);
        if (!tx) return;
        currentTransactionId = id;
        document.getElementById('correction-libelle').value = tx.libelle || '';
        document.getElementById('correction-categorie-actuelle').value = tx.categorie || '';
        populateCategorySelect(tx.categorie || 'Non class√©');
        document.getElementById('correction-commentaire').value = '';
        const typeSelect = document.getElementById('correction-type');
        if (typeSelect) {
            typeSelect.value = tx.depense_recurrente ? 'recurrente' : 'variable';
        }
        updateRecurrenceUI(tx);
        document.getElementById('correction-modal').classList.add('show');
    }

    function closeCorrectionModal() {
        document.getElementById('correction-modal').classList.remove('show');
    }

    async function submitCorrection() {
        const tx = transactionsCache.find(t => t.id === currentTransactionId);
        if (!tx) return;

        const nouvelleCategorie = document.getElementById('correction-categorie-nouvelle').value.trim();
        const commentaire = document.getElementById('correction-commentaire').value.trim();
        const nouveauType = document.getElementById('correction-type').value;
        const recurrenceTargetId = document.getElementById('recurrence-target').value || null;

        if (!nouvelleCategorie) {
            showNotification('Merci de proposer une nouvelle cat√©gorie', 'error');
            return;
        }

        try {
            const response = await fetch('/admin/api/classification/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    transaction_id: tx.id,
                    libelle: tx.libelle,
                    categorie_initiale: tx.categorie,
                    categorie_corrigee: nouvelleCategorie,
                    commentaire,
                    statut: 'corrige',
                    montant: tx.montant,
                    compte: tx.compte,
                    date_transaction: tx.date,
                    ml_confidence: tx.ml_confidence,
                    type_initial: tx.depense_recurrente ? 'recurrente' : 'variable',
                    type_corrige: nouveauType,
                    recurrence_target_id: recurrenceTargetId
                })
            });
            const result = await response.json();
            if (result.success) {
                showNotification('Correction enregistr√©e üëå', 'success');
                closeCorrectionModal();
                await loadTransactions();
                await loadHistory();
            } else {
                showNotification(result.error || 'Erreur lors de l\'enregistrement', 'error');
            }
        } catch (error) {
            showNotification('Erreur: ' + error.message, 'error');
        }
    }

    async function loadHistory() {
        try {
            const response = await fetch('/admin/api/classification/feedback?limit=30');
            const data = await response.json();
            if (!data.success) return;

            const container = document.getElementById('history-list');
            if (!data.history.length) {
                container.innerHTML = '<div class="history-item">Aucune correction enregistr√©e pour le moment.</div>';
                return;
            }

            container.innerHTML = data.history.map(item => `
                <div class="history-item">
                    <div>
                        <strong>${item.libelle}</strong><br>
                         <small>
                            ${(item.categorie_initiale || 'Non class√©')} ‚Üí ${(item.categorie_corrigee || 'Non class√©')}
                            ${
                                (item.type_initial && item.type_corrige && item.type_initial !== item.type_corrige)
                                    ? ` ¬∑ ${(item.type_initial === 'recurrente' ? 'Fixe' : 'Variable')} ‚Üí ${(item.type_corrige === 'recurrente' ? 'Fixe' : 'Variable')}`
                                    : ''
                            }
                         </small>
                    </div>
                    <div style="text-align:right;">
                        <div>${formatCurrency(item.montant)}</div>
                        <small>${new Date(item.created_at).toLocaleString('fr-FR')}</small>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Erreur historique corrections:', error);
        }
    }

    async function updateRecurrenceUI(tx) {
        const group = document.getElementById('recurrence-mapping-group');
        const select = document.getElementById('recurrence-target');
        const note = document.getElementById('recurrence-helper-note');
        if (!group || !select || !note) return;

        const typeValue = document.getElementById('correction-type').value;
        if (typeValue !== 'recurrente') {
            group.style.display = 'none';
            select.value = '';
            note.textContent = '';
            return;
        }

        group.style.display = 'block';
        note.textContent = 'Recherche des correspondances...';
        select.innerHTML = '<option value="">Cr√©er une nouvelle d√©pense r√©currente</option>';

        try {
            const response = await fetch(`/admin/api/classification/recurrence-suggestions?libelle=${encodeURIComponent(tx.libelle || '')}&montant=${Math.abs(tx.montant || 0)}`);
            const data = await response.json();
            recurrenceSuggestions = data.success ? (data.suggestions || []) : [];
        } catch (error) {
            recurrenceSuggestions = [];
        }

        if (!recurrenceSuggestions.length) {
            note.textContent = 'Aucune d√©pense r√©currente similaire d√©tect√©e.';
            return;
        }

        const options = ['<option value=\"\">Cr√©er une nouvelle d√©pense r√©currente</option>']
            .concat(recurrenceSuggestions.map(item => `
                <option value=\"${item.id}\">
                    ${item.libelle} (${formatCurrency(item.montant || 0)})
                </option>
            `));
        select.innerHTML = options.join('');
        select.value = recurrenceSuggestions[0]?.id || '';
        note.textContent = 'S√©lectionnez une d√©pense existante ou laissez vide pour en cr√©er une nouvelle.';
    }

    document.getElementById('correction-type').addEventListener('change', () => {
        if (!currentTransactionId) return;
        const tx = transactionsCache.find(t => t.id === currentTransactionId);
        if (tx) updateRecurrenceUI(tx);
    });

    loadCategories().then(() => {
        loadTransactions();
        loadHistory();
    });
</script>
{% endblock %}
